---
title: "Assessing methods to adjust for assay differences across COVID-19 serological surveillance studies in Canada"
execute: 
  echo: false
format:
  docx: 
    reference-doc: word-style-reference-manuscript.docx
  html: default
bibliography: bib.bib
csl: american-medical-association-brackets.csl
editor: visual
crossref: 
  thm-title: "Table"
  thm-prefix: "Table"
  cor-title: "Table S"
  cor-prefix: "Table S"
  lem-title: "Figure S"
  lem-prefix: "Figure S"
  fig-title: "**Figure**"
---

```{=html}
<!---

NOTES:
-   To render both word and HTML, can type this into terminal

quarto render 5_manuscript/manuscript.qmd

-   There are limits in cross-referencing in Quarto. The table
   Caption doesn't work well with flextable package, and 
  There's no option for secondary (supplemental) series of 
  tables or figures. As workaround, we repurpose other
  series.I'm using
        @thm- for tables (Table X)
        @cor- for supplemental tables (Table SX)
        @lem- for supplemental figures (Figure SX)
  The space between "S" and the number for supplemental figures seems unavoidable
   for now. Can manually correct before submitting to journal.
        
Flextable package isn't playing nicely with quarto for crossreferencing at the 
moment but it's being actively worked on. To install latest package version, use 
  devtools::install_github("davidgohel/flextable")

--->
```
Jiacheng Chen^1,2^, Yuan Yu^1^,..., W. Alton Russell^1,2^

<br>

^1^School of Population and Global Health, McGill University, Montreal, Canada

^2^COVID-19 Immunity Task Force

<br>

**Corresponding author:**

**Key words:**

**Running title:**

{{< pagebreak >}}

```{r setup, include=FALSE}
library(ggplot2)       #plots
library(data.table)    #for using datatables instead of frames
library(scales)        #formatting plot legends and text
library(readxl)        #read.excel
library(flextable)     #generating tables
# library(ftExtra)
# library(officedown)  #formatting for word
# library(officer)
# library(stringr)
theme_set(theme_bw())
```

```{r, include=FALSE}
# Load a sample dataset
df_samp <- read_excel("../1_data/tables.xlsx", sheet = "sample")

# This table to summarize three dataset we used
df_dataset <- read_excel("../1_data/tables.xlsx", sheet = "dataset")
```

# Abstract

**Background:** A

**Methods:** A

**Results:** A

**Conclusions:** A

{{< pagebreak >}}

# Introduction

Citation [@Langham2018a]. See @fig-sample, @cor-sample, @thm-sample, @thm-data, and @lem-sample.

The Covid-19 pandemic overview, global and what it looks like in Canada.

Serosurveillance programs in Canada, and its importance

Two types of antibodies to be detected by assays: Anti-S and Anti-N. Why we treated them differently in data analysis. Quantitative and qualitative test results.

anti-S (humoral response to infection or vaccination) and anti-N (marker of natural infection)

Waning of immunity against SARS-COV-2 after infection and immunization, indicated by decreasing blood Ab level overtime.

\[insert the figure of declining Ab with re-activation of immunization\]

Seropravalence and attack rate, why we need to employ RG equation or Bayesian model to estimated seropravalence, and why we also need models to adjust for waning immunity.

{{< pagebreak >}}

# Methods

**Notes**: Unlike the DBS vs VBS manuscript, the methods section of this project is mostly [unfinished]{.underline}. This section only shows the plan and the flow chart of the project in general, while the details of it needs constantly updating and polishing overtime, as the project goes. The potential obstacles were listed below:

-   APL assay data before the Omicron wave was mostly missing, Carmen said they have already approved the data access but the data is still on its way. Updates Jan-16-2024: Carmen said more data will be available soon.

-   In AB Outpatient Lab Data, they changed the assay (Diasorin S --\> Abbott S) in the midway, this would affect the validity of analysis based on quantitative test results, as the results from different assay are not directly comparable. Hopefully this can be clarified in the updated version of the dataset. Our currently analysis assume the Anti-S used in omicron wave are all Abbott's, based on the paper published by Carmen in the post-vax stage: https://doi.org/10.1080/23744235.2022.2080250

## Dataset

To estimate the SARS-CoV-2 seroprevalence and attack rate in Alberta, we used data from the Alberta Outpatient Lab (APL), Canadian Blood Services (CBS) and Canadian Partnership for Tomorrow's Health (CANPATH). Alberta Health Services (AHS) tested \>160,000 APL blood draws for SARS-CoV-2 anti-N and anti-S antibodies from June 2020 until October 2022. CBS has tested \>450,000 blood donations for both antibodies levels since March 2020. CANPATH has provided data with sample size \> XX. Besides of assay results, all three datasets include demographic variables such as donor's sex, self-reported race/ethnicity, and age. From their address, neighborhood material/social deprivation and urban/rural indicator have been derived.

**Notes**: *The paragraph below describes briefly about the time frame of data collection in those datasets. CBS is still actively updating (last ver downloaded on Nov 30th) and APL is also actively updating, we are currently waiting for additional linked variables from Carmen.*

The three datasets feature different data collection time frames. The CBS dataset has the most extended period, ranging from December 2020 to February 2023. APL's data collection spans from June 2020 to October 2022, but it's important to note that anti-N assay results are only available starting from December 2021. Meanwhile, the CANPATH dataset is accessible for a shorter duration, from September 2020 to May 2021.

We did not conduct analysis using a merged data, but instead, we conducted analysis separately for each data and presented the results in a graph panel (@fig-seroprevalence). @thm-data below summarized the differences among three data utilized in the study.

@thm-data CBS, CANPATH and APL

[insert @thm-data here if necessary]

## **Seroprevalence and attack rate**

To evaluate the severity of Covid-19 pandemic overtime in Alberta province, first we calculated the anti-N assay test positivity. Then, to bridge the gap between test positivity and population-level seroprevalence, we employed the Rogen-Gladen (RG) equation and Bayesian models. Following seroprevalence estimation, we further estimated the attack rate while adjusting for waning immunity using Bayesian models. These estimations are dessignated to answer what proportion of the target population that has been infected by SARS-CoV-2. We presented both seroprevalence and attack rate in a unified graph (@fig-seroprevalence), displaying changes over time on a monthly scale.

Rogan Gladen equation:

$$
Prevalence = \frac{TestPositivity + (Spec-1)}{Spec + (Sens-1))}
$$ Bayesian models adjusting for sensitivity:

\$\$

\$\$

Bayesian models adjusting for waning immunity: \$\$

\$\$

## **NT50 and corresponding antibody level:**

In evaluating whether participants possess humoral immunity levels sufficient to shield them from future infections, from either vaccination or infection, we applied a threshold of protection to the quantitative Anti-S assay results. The threshold is cited from the package insert of each assays \[Roche and Abbott\], indicating sufficient antibody level to neutralize over 50% virus, with certain times of dilution (1:20). We also presented the fluctuation of the proportion sufficiently protected over time in another figure (@fig-immunity), and we conducted sensitivity analyses in which we compared alternative threshold levels. The details of the sensitivity analysis is presented in the **Fig**. Y (haven't scratched this one yet).

[Insert @fig-immunity here if necessary]

<br>

# Results

ANOVA test, p-values...

<br>

# Discussion

Notes: The gap between Rogen-Gladen adjusted sero-prevalence and unadjused sero-positivity.

In our case, the sensitivity is where most variance come from. Specificity is good over time, and we shall not only take the numbers published by the manufacturer (Roche & Abbott) into consideration. Since sens is imperfect (0.8--1.0) and specificity is mostly 100% trustworthy (\~1.0), the R-G equation can be simplified as:

$$
Prevalence = \frac{TestPositivity}{Sens}
$$

According to the equation above, the worse the sens (smaller in value), the larger the gap between the adjusted (blue) and unadjusted (red). The gap is larger among unadjusted lines (red).

**Notes**: *Variances among data (APL, CBS, CANPATH) is not the major focus of this study, Yuan's paper will focus on those by evaluating the representativeness of the serosurveillance data. For this paper, the major focus should be the difference between adjusting methods. The potential readers of this papers includes those who are using serosurveillance data to monitor the progress of Covid pandemic, or other pathogens of interests which possess similar features as SARS-CoV-2.*

The take-home messages would be:

1.  Without any adjustment, the public health inference on test positivity is very limited. It only estimates the proportion of test positive results among blood samples collected in the serosurveillance study.
2.  Adjusting for certain factors will change the public health inference, meanwhile it will also improve its generalizability. When the imperfect nature of the seroassays is taken into account, the adjusted proportion of positive test results (seroprevalence) will be able to represent the target population in our target population, from which our sample has been collected. Upon the seroprevalence, after adjusting for seroreversion using Bayesian models, we get attack rates of SARS-CoV-2, which estimates the proportion of population infected by the virus since the beginning of pandemic.
3.  There's gap among all those different measurements, and also they have different public health inference. Future researchers should be cautious when making references to those different measurements.

<br>

{{< pagebreak >}}

# Declarations

**Funding:** A

**Conflicts:** A

**Ethics/Consent:** A

**Data and materials:** A

**Code availability:** A

**Authors' contributions: A**

{{< pagebreak >}}

# References

::: {#refs}
:::

{{< pagebreak >}}

# Tables

::: {#thm-sample}
This is a sample table

```{r}
t_samp <- as_flextable(as_grouped_data(df_samp,
                                              groups = "subhead"))
t_samp <- compose(t_samp, i = ~ !is.na(subhead), j = "col1",
              value = as_paragraph(as_chunk(subhead)))
t_samp <- fontsize(t_samp, size = 10, part = "all")
t_samp <- font(t_samp, fontname = "Times", part = "all")
t_samp <- theme_box(t_samp)
t_samp <- bg(t_samp, bg = "#EAEAEA", part = "header")
t_samp <- width(t_samp, 1, 1.7)
t_samp <- bg(t_samp, i = c(1, 4), bg = "#DDDDDD", part = "body")
t_samp <- bold(t_samp, i = c(1, 4), part = "body")
t_samp <- align(t_samp, align = "left", part = "all")

t_samp
```
:::

::: {#thm-data}
The table below displays the distribution of age groups and gender across all three datasets. It also details the provinces where the data was collected, along with the corresponding data collection periods.

```{r}
t_dataset<-as_flextable(df_dataset)
t_dataset <- fontsize(t_dataset, size = 10, part = "all")
t_dataset <- font(t_dataset, fontname = "Times", part = "all")

t_dataset <- bold(t_dataset, i = 1, part = "header")
t_dataset <- bold(t_dataset, i = c(2, 6, 9), part = "body")

#t_dataset <- theme_box(t_dataset)
#t_dataset <- bg(t_dataset, bg = "#EAEAEA", part = "header")
#t_dataset <- width(t_dataset, 1, 1.7)
#t_dataset <- bg(t_dataset, i = c(1, 4), bg = "#DDDDDD", part = "body")
#t_dataset <- bold(t_dataset, i = c(1, 4), part = "body")
#t_dataset <- align(t_dataset, align = "left", part = "all")

t_dataset
```
:::

{{< pagebreak >}}

# Figures

```{r}
#| label: fig-sample
#| fig-cap: "Figure caption here."

knitr::include_graphics("../4_output/figs/figure.png")
```

```{r}
#| label: fig-seroprevalence
#| fig-cap: "The figure panel above presents the temporal changes in seroprevalence and attack rate, grouped by province and data source. Each figure displays the unadjusted seropositivity, the seroprevalence adjusted using the Rogan-Gladen equation, the seroprevalence adjusted by Bayesian models, and the attack rates. The calculations of seropositivity, seroprevalence, and attack rate are based on the qualitative results of the anti-N assay. 
#| (Just a scratch, not the real fig)"

knitr::include_graphics("../4_output/figs/Figure.1 Seroprelance and attack rate by province and data source.png")
```

```{r}
#| label: fig-immunity
#| fig-cap: "The figure panel above depicts the temporal fluctuations in quantitative anti-S assay results, grouped by province and data source. Two cutoff indices (COIs) are utilized for different public health interpretations. The COI of 0.8, recommended by the manufacturer (Roche), is optimal for identifying the presence of antibodies in the blood sample. Meanwhile, a COI of 15 is indicative of a threshold for sufficient humoral immunity against the SARS-CoV-2 virus. We also applied Rogen-Gladen equation and Bayesian models to adjust for test sensitivity.
#| (Just one fig, will add more to build a panel)"

knitr::include_graphics("../4_output/figs/Figure.2 Immunity.png")
```

{{< pagebreak >}}

# Supplemental materials

<br>

# A. Supplement section

## Supplement Methods

Besides of serology test results and demographic data, CBS has linked the administrative data for the cohort, which provided additional information on their hospitalizations, clinic visits, diagnoses, COVID vaccinations, and long-term disability claims. Similarly, AHS and CANPATH have completed linkages and included additional vaccination history.

**Notes**: *Current ver of APL has completed very limited data linkage, which only includes PCR test results/time and vaccination time. The paragraph briefly describe the data linkage for three datasets, however for now we do not need those variables from linked administrative data.*

{{< pagebreak >}}

# Supplemental tables

::: {#cor-sample}
Table caption here.

```{r}
t_samp <- as_flextable(as_grouped_data(df_samp,
                                              groups = "subhead"))
t_samp <- compose(t_samp, i = ~ !is.na(subhead), j = "col1",
              value = as_paragraph(as_chunk(subhead)))
t_samp <- fontsize(t_samp, size = 10, part = "all")
t_samp <- font(t_samp, fontname = "Times", part = "all")
t_samp <- theme_box(t_samp)
t_samp <- bg(t_samp, bg = "#EAEAEA", part = "header")
t_samp <- width(t_samp, 1, 1.7)
t_samp <- bg(t_samp, i = c(1, 4), bg = "#DDDDDD", part = "body")
t_samp <- bold(t_samp, i = c(1, 4), part = "body")
t_samp <- align(t_samp, align = "left", part = "all")

t_samp
```
:::

{{< pagebreak >}}

# Supplemental figures

::: {#lem-sample}
Figure caption here.

```{r}
knitr::include_graphics("../4_output/figs/figure.png")
```
:::
